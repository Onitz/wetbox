<!DOCTYPE html>
<html>
<head>
<style>
body, html {
  margin:0;
  padding:0;
  height:100%;
}
</style>
<script src="../three.min.js"></script>
</head>
<body>
<script>

let canvasEl, renderer, camera, box
let uniforms, fragMaterial, mesh, fShader
let mouseNormX, mouseNormY, prevMouseNormX, prevMouseNormY, mouseDelX, mouseDelY

let startTime = Date.now()
let loader = new THREE.FileLoader()
let scene = new THREE.Scene()

loader.load( 'frag.glsl', init ) // load the fragment shader and kick off the program

function init( fShader ) {

  vShader = `uniform float time; uniform vec2 resolution; void main() { gl_Position = vec4( position, 1.0 ); }`
  uniforms = {
    time:       { type:  "f", value: 1.0 },
    resolution: { type: "v2", value: new THREE.Vector2() },
} //   mouse:      { type: "v2", value: new THREE.Vector2( mouseNormX, mouseNormY ) },
  //   mouseDelta: { type: "v2", value: new THREE.Vector2( mouseDelX, mouseDelY ) },
  //   audio:      { value: [1,2,3,4,5,6,7,8] }
  // }
  fragMaterial = new THREE.ShaderMaterial({
    uniforms: uniforms,
    vertexShader: vShader,
    fragmentShader: fShader
  })

  //custom fragShader
  //mesh = new THREE.Mesh( new THREE.PlaneGeometry( 2, 2 ), fragMaterial );
  //scene.add( mesh );

  addBox()

  addLights()
  addCamera( 10, 10, 10 )
  addAction()
}

function addAction() {
  renderer = new THREE.WebGLRenderer()
  renderer.setClearColor( 0x444444, 1 )
  canvasEl = document.body.appendChild( renderer.domElement )
  canvasEl.style.display = 'block'

  addListeners()
  doResize()
  animate()
}

function addListeners() {
  window.addEventListener( 'mousemove', mouseHandler )
  window.addEventListener( 'touchmove', mouseHandler )
  window.addEventListener( 'resize', doResize )
}

function addCamera( posX, posY, posZ ) {
  camera = new THREE.PerspectiveCamera( 100, window.innerWidth / window.innerHeight, 1, 10000 )
  camera.position.set( posX, posY, posZ )
  camera.lookAt( 0, 0, 0 )
}

function addLights() {
  scene.add( new THREE.AmbientLight( 0xffffff ) )
  let light = new THREE.PointLight( 0xffffff, 2 )
  light.position.set( 20, 15, -15 )
  scene.add( light )
}

function addBox() {
  let boxGeometry = new THREE.BoxGeometry( 10, 10, 10 )
  let boxMaterial = new THREE.MeshLambertMaterial( { color: 0x666666, flatShading: THREE.SmoothShading } )
  box = new THREE.Mesh( boxGeometry, boxMaterial )
  scene.add( box )
}

function doResize() {
  camera.aspect = window.innerWidth / window.innerHeight
  camera.updateProjectionMatrix()
  renderer.setSize( window.innerWidth, window.innerHeight )  
}

function animate() {
  window.requestAnimationFrame( animate )
  render()
}

function render() {
  let elapsedMilliseconds = Date.now() - startTime
  uniforms.time.value = elapsedMilliseconds
  renderer.render( scene, camera )
}

function mouseHandler( e ) {
  if (e.targetTouches) {
    var touch = e.targetTouches[ 0 ]
    mouseX = touch.pageX
    mouseY = touch.pageY
  } else {
    mouseX = e.clientX
    mouseY = e.clientY
  }

  mouseNormX = mouseX / canvasEl.innerWidth
  mouseNormY = 1. - mouseY / canvasEl.innerHeight
  mouseDelX = mouseNormX - prevMouseNormX
  mouseDelY = mouseNormY - prevMouseNormY
  prevMouseNormX = mouseNormX
  prevMouseNormY = mouseNormY
}
</script>
</body>
</html>